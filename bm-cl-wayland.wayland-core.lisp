(DEFPACKAGE :WL_DISPLAY
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-DISPLAY)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           SYNC
           GET-REGISTRY
           SEND-ERROR
           SEND-DELETE-ID))

(IN-PACKAGE :WL_DISPLAY)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (SYNC :POINTER)
 (GET_REGISTRY :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_REGISTRY
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-REGISTRY)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND BIND SEND-GLOBAL SEND-GLOBAL-REMOVE))

(IN-PACKAGE :WL_REGISTRY)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (BIND :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_CALLBACK
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-CALLBACK)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND SEND-DONE))

(IN-PACKAGE :WL_CALLBACK)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_COMPOSITOR
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-COMPOSITOR)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND CREATE-SURFACE CREATE-REGION))

(IN-PACKAGE :WL_COMPOSITOR)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (CREATE_SURFACE :POINTER)
 (CREATE_REGION :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SHM_POOL
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SHM-POOL)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND CREATE-BUFFER DESTROY RESIZE))

(IN-PACKAGE :WL_SHM_POOL)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (CREATE_BUFFER :POINTER)
 (DESTROY :POINTER) (RESIZE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SHM
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SHM)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND CREATE-POOL SEND-FORMAT))

(IN-PACKAGE :WL_SHM)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (CREATE_POOL :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_BUFFER
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-BUFFER)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND DESTROY SEND-RELEASE))

(IN-PACKAGE :WL_BUFFER)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (DESTROY :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_DATA_OFFER
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-DATA-OFFER)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           ACCEPT
           RECEIVE
           DESTROY
           FINISH
           SET-ACTIONS
           SEND-OFFER
           SEND-SOURCE-ACTIONS
           SEND-ACTION))

(IN-PACKAGE :WL_DATA_OFFER)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (ACCEPT :POINTER) (RECEIVE :POINTER)
 (DESTROY :POINTER) (FINISH :POINTER) (SET_ACTIONS :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_DATA_SOURCE
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-DATA-SOURCE)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           OFFER
           DESTROY
           SET-ACTIONS
           SEND-TARGET
           SEND-SEND
           SEND-CANCELLED
           SEND-DND-DROP-PERFORMED
           SEND-DND-FINISHED
           SEND-ACTION))

(IN-PACKAGE :WL_DATA_SOURCE)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (OFFER :POINTER) (DESTROY :POINTER)
 (SET_ACTIONS :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_DATA_DEVICE
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-DATA-DEVICE)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           START-DRAG
           SET-SELECTION
           RELEASE
           SEND-DATA-OFFER
           SEND-ENTER
           SEND-LEAVE
           SEND-MOTION
           SEND-DROP
           SEND-SELECTION))

(IN-PACKAGE :WL_DATA_DEVICE)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (START_DRAG :POINTER)
 (SET_SELECTION :POINTER) (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_DATA_DEVICE_MANAGER
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-DATA-DEVICE-MANAGER)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND CREATE-DATA-SOURCE GET-DATA-DEVICE))

(IN-PACKAGE :WL_DATA_DEVICE_MANAGER)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (CREATE_DATA_SOURCE :POINTER)
 (GET_DATA_DEVICE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SHELL
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SHELL)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND GET-SHELL-SURFACE))

(IN-PACKAGE :WL_SHELL)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (GET_SHELL_SURFACE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SHELL_SURFACE
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SHELL-SURFACE)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           PONG
           MOVE
           RESIZE
           SET-TOPLEVEL
           SET-TRANSIENT
           SET-FULLSCREEN
           SET-POPUP
           SET-MAXIMIZED
           SET-TITLE
           SET-CLASS
           SEND-PING
           SEND-CONFIGURE
           SEND-POPUP-DONE))

(IN-PACKAGE :WL_SHELL_SURFACE)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (PONG :POINTER) (MOVE :POINTER)
 (RESIZE :POINTER) (SET_TOPLEVEL :POINTER) (SET_TRANSIENT :POINTER)
 (SET_FULLSCREEN :POINTER) (SET_POPUP :POINTER) (SET_MAXIMIZED :POINTER)
 (SET_TITLE :POINTER) (SET_CLASS :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SURFACE
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SURFACE)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           DESTROY
           ATTACH
           DAMAGE
           FRAME
           SET-OPAQUE-REGION
           SET-INPUT-REGION
           COMMIT
           SET-BUFFER-TRANSFORM
           SET-BUFFER-SCALE
           DAMAGE-BUFFER
           OFFSET
           SEND-ENTER
           SEND-LEAVE
           SEND-PREFERRED-BUFFER-SCALE
           SEND-PREFERRED-BUFFER-TRANSFORM))

(IN-PACKAGE :WL_SURFACE)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (DESTROY :POINTER) (ATTACH :POINTER)
 (DAMAGE :POINTER) (FRAME :POINTER) (SET_OPAQUE_REGION :POINTER)
 (SET_INPUT_REGION :POINTER) (COMMIT :POINTER) (SET_BUFFER_TRANSFORM :POINTER)
 (SET_BUFFER_SCALE :POINTER) (DAMAGE_BUFFER :POINTER) (OFFSET :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SEAT
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SEAT)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           GET-POINTER
           GET-KEYBOARD
           GET-TOUCH
           RELEASE
           SEND-CAPABILITIES
           SEND-NAME))

(IN-PACKAGE :WL_SEAT)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (GET_POINTER :POINTER)
 (GET_KEYBOARD :POINTER) (GET_TOUCH :POINTER) (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_POINTER
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-POINTER)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           SET-CURSOR
           RELEASE
           SEND-ENTER
           SEND-LEAVE
           SEND-MOTION
           SEND-BUTTON
           SEND-AXIS
           SEND-FRAME
           SEND-AXIS-SOURCE
           SEND-AXIS-STOP
           SEND-AXIS-DISCRETE
           SEND-AXIS-VALUE120
           SEND-AXIS-RELATIVE-DIRECTION))

(IN-PACKAGE :WL_POINTER)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (SET_CURSOR :POINTER)
 (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_KEYBOARD
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-KEYBOARD)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           RELEASE
           SEND-KEYMAP
           SEND-ENTER
           SEND-LEAVE
           SEND-KEY
           SEND-MODIFIERS
           SEND-REPEAT-INFO))

(IN-PACKAGE :WL_KEYBOARD)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_TOUCH
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-TOUCH)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           RELEASE
           SEND-DOWN
           SEND-UP
           SEND-MOTION
           SEND-FRAME
           SEND-CANCEL
           SEND-SHAPE
           SEND-ORIENTATION))

(IN-PACKAGE :WL_TOUCH)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_OUTPUT
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-OUTPUT)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           RELEASE
           SEND-GEOMETRY
           SEND-MODE
           SEND-DONE
           SEND-SCALE
           SEND-NAME
           SEND-DESCRIPTION))

(IN-PACKAGE :WL_OUTPUT)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (RELEASE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_REGION
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-REGION)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND DESTROY ADD SUBTRACT))

(IN-PACKAGE :WL_REGION)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (DESTROY :POINTER) (ADD :POINTER)
 (SUBTRACT :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SUBCOMPOSITOR
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SUBCOMPOSITOR)
  (:EXPORT DISPATCH GLOBAL DISPATCH-BIND DESTROY GET-SUBSURFACE))

(IN-PACKAGE :WL_SUBCOMPOSITOR)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (DESTROY :POINTER)
 (GET_SUBSURFACE :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(DEFPACKAGE :WL_SUBSURFACE
  (:USE :CL :WL :CFFI)
  (:NICKNAMES :WL-SUBSURFACE)
  (:EXPORT DISPATCH
           GLOBAL
           DISPATCH-BIND
           DESTROY
           SET-POSITION
           PLACE-ABOVE
           PLACE-BELOW
           SET-SYNC
           SET-DESYNC))

(IN-PACKAGE :WL_SUBSURFACE)

(DEFCSTRUCT INTERFACE (NAME :STRING) (VERSION :INT) (METHOD_COUNT :INT)
 (METHODS (:POINTER (:STRUCT WL_MESSAGE))) (EVENT_COUNT :INT)
 (EVENTS (:POINTER (:STRUCT WL_MESSAGE))) (DESTROY :POINTER)
 (SET_POSITION :POINTER) (PLACE_ABOVE :POINTER) (PLACE_BELOW :POINTER)
 (SET_SYNC :POINTER) (SET_DESYNC :POINTER))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *INTERFACE* (CFFI:FOREIGN-ALLOC '(:STRUCT INTERFACE))))

(IN-PACKAGE :WL_DISPLAY)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "core global object

The core global object.  This is a special singleton object.  It
      is used for internal Wayland protocol features.
"))

(DEFGENERIC SYNC
    (RESOURCE CALLBACK))

(DEFGENERIC GET-REGISTRY
    (RESOURCE REGISTRY))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_CALLBACK::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "sync")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_REGISTRY::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_registry")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "error")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "ous")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "delete_id")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_display")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_display")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'SYNC RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (1
         (FUNCALL 'GET-REGISTRY RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-ERROR ((DISPATCH DISPATCH) OBJECT_ID CODE MESSAGE)
  (DEBUG-LOG! "Event: ~a~%" "error")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" OBJECT_ID)
              ("uint" OBJECT_ID)
              ("new_id" OBJECT_ID)
              ("fixed" OBJECT_ID)
              ("fd" OBJECT_ID)
              ("string" OBJECT_ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" CODE)
              ("uint" CODE)
              ("new_id" CODE)
              ("fixed" CODE)
              ("fd" CODE)
              ("string" CODE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MESSAGE)
              ("uint" MESSAGE)
              ("new_id" MESSAGE)
              ("fixed" MESSAGE)
              ("fd" MESSAGE)
              ("string" MESSAGE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-DELETE-ID ((DISPATCH DISPATCH) ID)
  (DEBUG-LOG! "Event: ~a~%" "delete_id")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "core global object

The core global object.  This is a special singleton object.  It
      is used for internal Wayland protocol features.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_display global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_display")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_display")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_display")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_REGISTRY)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "global registry object

The singleton global registry object.  The server has a number of
      global objects that are available to all clients.  These objects
      typically represent an actual object in the server (for example,
      an input device) or they are singleton objects that provide
      extension functionality.

      When a client creates a registry object, the registry object
      will emit a global event for each global currently in the
      registry.  Globals come and go as a result of device or
      monitor hotplugs, reconfiguration or other events, and the
      registry will send out global and global_remove events to
      keep the client up to date with the changes.  To mark the end
      of the initial burst of events, the client can use the
      wl_display.sync request immediately after calling
      wl_display.get_registry.

      A client can bind to a global object by using the bind
      request.  This creates a client-side handle that lets the object
      emit events to the client and lets the client invoke requests on
      the object.
"))

(DEFGENERIC BIND
    (RESOURCE NAME ID))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "bind")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "un")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "global")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "usu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "global_remove")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_registry")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_registry")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'BIND RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-GLOBAL ((DISPATCH DISPATCH) NAME INTERFACE VERSION)
  (DEBUG-LOG! "Event: ~a~%" "global")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" NAME)
              ("uint" NAME)
              ("new_id" NAME)
              ("fixed" NAME)
              ("fd" NAME)
              ("string" NAME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" INTERFACE)
              ("uint" INTERFACE)
              ("new_id" INTERFACE)
              ("fixed" INTERFACE)
              ("fd" INTERFACE)
              ("string" INTERFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" VERSION)
              ("uint" VERSION)
              ("new_id" VERSION)
              ("fixed" VERSION)
              ("fd" VERSION)
              ("string" VERSION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-GLOBAL-REMOVE ((DISPATCH DISPATCH) NAME)
  (DEBUG-LOG! "Event: ~a~%" "global_remove")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" NAME)
              ("uint" NAME)
              ("new_id" NAME)
              ("fixed" NAME)
              ("fd" NAME)
              ("string" NAME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "global registry object

The singleton global registry object.  The server has a number of
      global objects that are available to all clients.  These objects
      typically represent an actual object in the server (for example,
      an input device) or they are singleton objects that provide
      extension functionality.

      When a client creates a registry object, the registry object
      will emit a global event for each global currently in the
      registry.  Globals come and go as a result of device or
      monitor hotplugs, reconfiguration or other events, and the
      registry will send out global and global_remove events to
      keep the client up to date with the changes.  To mark the end
      of the initial burst of events, the client can use the
      wl_display.sync request immediately after calling
      wl_display.get_registry.

      A client can bind to a global object by using the bind
      request.  This creates a client-side handle that lets the object
      emit events to the client and lets the client invoke requests on
      the object.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_registry global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_registry")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_registry")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_registry")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_CALLBACK)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "callback object

Clients can handle the 'done' event to get notified when
      the related request is done.

      Note, because wl_callback objects are created from multiple independent
      factory interfaces, the wl_callback interface is frozen at version 1.
"))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "done")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_callback")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE ARGS TARGET OPCODE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_callback")
    (ERROR
     (FORMAT NIL
             "A dispatcher wiwthout requests has been called for interface: ~a~%"
             "wl_callback"))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-DONE ((DISPATCH DISPATCH) CALLBACK_DATA)
  (DEBUG-LOG! "Event: ~a~%" "done")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" CALLBACK_DATA)
              ("uint" CALLBACK_DATA)
              ("new_id" CALLBACK_DATA)
              ("fixed" CALLBACK_DATA)
              ("fd" CALLBACK_DATA)
              ("string" CALLBACK_DATA)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "callback object

Clients can handle the 'done' event to get notified when
      the related request is done.

      Note, because wl_callback objects are created from multiple independent
      factory interfaces, the wl_callback interface is frozen at version 1.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_callback global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_callback")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_callback")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_callback")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_COMPOSITOR)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 6)
          (:DOCUMENTATION "the compositor singleton

A compositor.  This object is a singleton global.  The
      compositor is in charge of combining the contents of multiple
      surfaces into one displayable output.
"))

(DEFGENERIC CREATE-SURFACE
    (RESOURCE ID))

(DEFGENERIC CREATE-REGION
    (RESOURCE ID))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "create_surface")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_REGION::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "create_region")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_compositor")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_compositor")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'CREATE-SURFACE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (1
         (FUNCALL 'CREATE-REGION RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 6 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "the compositor singleton

A compositor.  This object is a singleton global.  The
      compositor is in charge of combining the contents of multiple
      surfaces into one displayable output.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_compositor global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_compositor")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_compositor")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_compositor")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SHM_POOL)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "a shared memory pool

The wl_shm_pool object encapsulates a piece of memory shared
      between the compositor and client.  Through the wl_shm_pool
      object, the client can allocate shared memory wl_buffer objects.
      All objects created through the same pool share the same
      underlying mapped memory. Reusing the mapped memory avoids the
      setup/teardown overhead and is useful when interactively resizing
      a surface or for many small buffers.
"))

(DEFGENERIC CREATE-BUFFER
    (RESOURCE ID OFFSET WIDTH HEIGHT STRIDE FORMAT))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC RESIZE
    (RESOURCE SIZE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 6)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_BUFFER::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 5) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "create_buffer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "niiiiu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "resize")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "i")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_shm_pool")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_shm_pool")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'CREATE-BUFFER RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))
        (1 (FUNCALL 'DESTROY RESOURCE))
        (2
         (FUNCALL 'RESIZE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "a shared memory pool

The wl_shm_pool object encapsulates a piece of memory shared
      between the compositor and client.  Through the wl_shm_pool
      object, the client can allocate shared memory wl_buffer objects.
      All objects created through the same pool share the same
      underlying mapped memory. Reusing the mapped memory avoids the
      setup/teardown overhead and is useful when interactively resizing
      a surface or for many small buffers.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_shm_pool global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_shm_pool")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_shm_pool")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_shm_pool")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SHM)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "shared memory support

A singleton global object that provides support for shared
      memory.

      Clients can create wl_shm_pool objects using the create_pool
      request.

      On binding the wl_shm object one or more format events
      are emitted to inform clients about the valid pixel formats
      that can be used for buffers.
"))

(DEFGENERIC CREATE-POOL
    (RESOURCE ID FD SIZE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SHM_POOL::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "create_pool")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "nhi")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "format")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_shm")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_shm")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'CREATE-POOL RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::H))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-FORMAT ((DISPATCH DISPATCH) FORMAT)
  (DEBUG-LOG! "Event: ~a~%" "format")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FORMAT)
              ("uint" FORMAT)
              ("new_id" FORMAT)
              ("fixed" FORMAT)
              ("fd" FORMAT)
              ("string" FORMAT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "shared memory support

A singleton global object that provides support for shared
      memory.

      Clients can create wl_shm_pool objects using the create_pool
      request.

      On binding the wl_shm object one or more format events
      are emitted to inform clients about the valid pixel formats
      that can be used for buffers.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_shm global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_shm")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_shm")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_shm")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_BUFFER)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "content for a wl_surface

A buffer provides the content for a wl_surface. Buffers are
      created through factory interfaces such as wl_shm, wp_linux_buffer_params
      (from the linux-dmabuf protocol extension) or similar. It has a width and
      a height and can be attached to a wl_surface, but the mechanism by which a
      client provides and updates the contents is defined by the buffer factory
      interface.

      If the buffer uses a format that has an alpha channel, the alpha channel
      is assumed to be premultiplied in the color channels unless otherwise
      specified.

      Note, because wl_buffer objects are created from multiple independent
      factory interfaces, the wl_buffer interface is frozen at version 1.
"))

(DEFGENERIC DESTROY
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_buffer")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE ARGS))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_buffer")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE (0 (FUNCALL 'DESTROY RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-RELEASE ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "release")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "content for a wl_surface

A buffer provides the content for a wl_surface. Buffers are
      created through factory interfaces such as wl_shm, wp_linux_buffer_params
      (from the linux-dmabuf protocol extension) or similar. It has a width and
      a height and can be attached to a wl_surface, but the mechanism by which a
      client provides and updates the contents is defined by the buffer factory
      interface.

      If the buffer uses a format that has an alpha channel, the alpha channel
      is assumed to be premultiplied in the color channels unless otherwise
      specified.

      Note, because wl_buffer objects are created from multiple independent
      factory interfaces, the wl_buffer interface is frozen at version 1.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_buffer global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_buffer")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_buffer")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_buffer")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_DATA_OFFER)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 3)
          (:DOCUMENTATION "offer to transfer data

A wl_data_offer represents a piece of data offered for transfer
      by another client (the source client).  It is used by the
      copy-and-paste and drag-and-drop mechanisms.  The offer
      describes the different mime types that the data can be
      converted to and provides the mechanism for transferring the
      data directly from the source client.
"))

(DEFGENERIC ACCEPT
    (RESOURCE SERIAL MIME_TYPE))

(DEFGENERIC RECEIVE
    (RESOURCE MIME_TYPE FD))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC FINISH
    (RESOURCE))

(DEFGENERIC SET-ACTIONS
    (RESOURCE DND_ACTIONS PREFERRED_ACTION))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 5)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "accept")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u?s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "receive")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "sh")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "finish")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_actions")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3uu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "offer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "source_actions")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "action")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_data_offer")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 5
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_data_offer")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'ACCEPT RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::S))))
        (1
         (FUNCALL 'RECEIVE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::S))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::H))))
        (2 (FUNCALL 'DESTROY RESOURCE))
        (3 (FUNCALL 'FINISH RESOURCE))
        (4
         (FUNCALL 'SET-ACTIONS RESOURCE
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-OFFER ((DISPATCH DISPATCH) MIME_TYPE)
  (DEBUG-LOG! "Event: ~a~%" "offer")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MIME_TYPE)
              ("uint" MIME_TYPE)
              ("new_id" MIME_TYPE)
              ("fixed" MIME_TYPE)
              ("fd" MIME_TYPE)
              ("string" MIME_TYPE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-SOURCE-ACTIONS ((DISPATCH DISPATCH) SOURCE_ACTIONS)
  (DEBUG-LOG! "Event: ~a~%" "source_actions")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SOURCE_ACTIONS)
              ("uint" SOURCE_ACTIONS)
              ("new_id" SOURCE_ACTIONS)
              ("fixed" SOURCE_ACTIONS)
              ("fd" SOURCE_ACTIONS)
              ("string" SOURCE_ACTIONS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-ACTION ((DISPATCH DISPATCH) DND_ACTION)
  (DEBUG-LOG! "Event: ~a~%" "action")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DND_ACTION)
              ("uint" DND_ACTION)
              ("new_id" DND_ACTION)
              ("fixed" DND_ACTION)
              ("fd" DND_ACTION)
              ("string" DND_ACTION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 3 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "offer to transfer data

A wl_data_offer represents a piece of data offered for transfer
      by another client (the source client).  It is used by the
      copy-and-paste and drag-and-drop mechanisms.  The offer
      describes the different mime types that the data can be
      converted to and provides the mechanism for transferring the
      data directly from the source client.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_data_offer global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_data_offer")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_data_offer")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_data_offer")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_DATA_SOURCE)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 3)
          (:DOCUMENTATION "offer to transfer data

The wl_data_source object is the source side of a wl_data_offer.
      It is created by the source client in a data transfer and
      provides a way to describe the offered data and a way to respond
      to requests to transfer the data.
"))

(DEFGENERIC OFFER
    (RESOURCE MIME_TYPE))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC SET-ACTIONS
    (RESOURCE DND_ACTIONS))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "offer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_actions")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 6)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "target")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "send")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "sh")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "cancelled")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "dnd_drop_performed")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "dnd_finished")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "action")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_data_source")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_data_source")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'OFFER RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::S))))
        (1 (FUNCALL 'DESTROY RESOURCE))
        (2
         (FUNCALL 'SET-ACTIONS RESOURCE
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-TARGET ((DISPATCH DISPATCH) MIME_TYPE)
  (DEBUG-LOG! "Event: ~a~%" "target")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MIME_TYPE)
              ("uint" MIME_TYPE)
              ("new_id" MIME_TYPE)
              ("fixed" MIME_TYPE)
              ("fd" MIME_TYPE)
              ("string" MIME_TYPE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-SEND ((DISPATCH DISPATCH) MIME_TYPE FD)
  (DEBUG-LOG! "Event: ~a~%" "send")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MIME_TYPE)
              ("uint" MIME_TYPE)
              ("new_id" MIME_TYPE)
              ("fixed" MIME_TYPE)
              ("fd" MIME_TYPE)
              ("string" MIME_TYPE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::H)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FD)
              ("uint" FD)
              ("new_id" FD)
              ("fixed" FD)
              ("fd" FD)
              ("string" FD)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-CANCELLED ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "cancelled")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-DND-DROP-PERFORMED ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "dnd_drop_performed")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-DND-FINISHED ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "dnd_finished")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-ACTION ((DISPATCH DISPATCH) DND_ACTION)
  (DEBUG-LOG! "Event: ~a~%" "action")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DND_ACTION)
              ("uint" DND_ACTION)
              ("new_id" DND_ACTION)
              ("fixed" DND_ACTION)
              ("fd" DND_ACTION)
              ("string" DND_ACTION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 3 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "offer to transfer data

The wl_data_source object is the source side of a wl_data_offer.
      It is created by the source client in a data transfer and
      provides a way to describe the offered data and a way to respond
      to requests to transfer the data.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_data_source global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_data_source")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_data_source")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_data_source")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_DATA_DEVICE)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 3)
          (:DOCUMENTATION "data transfer device

There is one wl_data_device per seat which can be obtained
      from the global wl_data_device_manager singleton.

      A wl_data_device provides access to inter-client data transfer
      mechanisms such as copy-and-paste and drag-and-drop.
"))

(DEFGENERIC START-DRAG
    (RESOURCE SOURCE ORIGIN ICON SERIAL))

(DEFGENERIC SET-SELECTION
    (RESOURCE SOURCE SERIAL))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0)
                WL_DATA_SOURCE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "start_drag")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?oo?ou")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0)
                WL_DATA_SOURCE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_selection")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?ou")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "2")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 6)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_DATA_OFFER::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "data_offer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 5)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) WL_DATA_OFFER::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "enter")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uoff?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "leave")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "motion")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "drop")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_DATA_OFFER::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "selection")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_data_device")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_data_device")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'START-DRAG RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))))
        (1
         (FUNCALL 'SET-SELECTION RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))))
        (2 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-DATA-OFFER ((DISPATCH DISPATCH) ID)
  (DEBUG-LOG! "Event: ~a~%" "data_offer")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::N)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-ENTER ((DISPATCH DISPATCH) SERIAL SURFACE X Y ID)
  (DEBUG-LOG! "Event: ~a~%" "enter")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 5)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" X)
              ("uint" X)
              ("new_id" X)
              ("fixed" X)
              ("fd" X)
              ("string" X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" Y)
              ("uint" Y)
              ("new_id" Y)
              ("fixed" Y)
              ("fd" Y)
              ("string" Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-LEAVE ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "leave")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-MOTION ((DISPATCH DISPATCH) TIME X Y)
  (DEBUG-LOG! "Event: ~a~%" "motion")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" X)
              ("uint" X)
              ("new_id" X)
              ("fixed" X)
              ("fd" X)
              ("string" X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" Y)
              ("uint" Y)
              ("new_id" Y)
              ("fixed" Y)
              ("fd" Y)
              ("string" Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-DROP ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "drop")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-SELECTION ((DISPATCH DISPATCH) ID)
  (DEBUG-LOG! "Event: ~a~%" "selection")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 3 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "data transfer device

There is one wl_data_device per seat which can be obtained
      from the global wl_data_device_manager singleton.

      A wl_data_device provides access to inter-client data transfer
      mechanisms such as copy-and-paste and drag-and-drop.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_data_device global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_data_device")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_data_device")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_data_device")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_DATA_DEVICE_MANAGER)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 3)
          (:DOCUMENTATION "data transfer interface

The wl_data_device_manager is a singleton global object that
      provides access to inter-client data transfer mechanisms such as
      copy-and-paste and drag-and-drop.  These mechanisms are tied to
      a wl_seat and this interface lets a client get a wl_data_device
      corresponding to a wl_seat.

      Depending on the version bound, the objects created from the bound
      wl_data_device_manager object will have different requirements for
      functioning properly. See wl_data_source.set_actions,
      wl_data_offer.accept and wl_data_offer.finish for details.
"))

(DEFGENERIC CREATE-DATA-SOURCE
    (RESOURCE ID))

(DEFGENERIC GET-DATA-DEVICE
    (RESOURCE ID SEAT))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0)
                WL_DATA_SOURCE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "create_data_source")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0)
                WL_DATA_DEVICE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SEAT::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_data_device")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "no")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_data_device_manager")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_data_device_manager")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'CREATE-DATA-SOURCE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (1
         (FUNCALL 'GET-DATA-DEVICE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 3 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "data transfer interface

The wl_data_device_manager is a singleton global object that
      provides access to inter-client data transfer mechanisms such as
      copy-and-paste and drag-and-drop.  These mechanisms are tied to
      a wl_seat and this interface lets a client get a wl_data_device
      corresponding to a wl_seat.

      Depending on the version bound, the objects created from the bound
      wl_data_device_manager object will have different requirements for
      functioning properly. See wl_data_source.set_actions,
      wl_data_offer.accept and wl_data_offer.finish for details.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_data_device_manager global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_data_device_manager")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_data_device_manager")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_data_device_manager")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SHELL)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "create desktop-style surfaces

This interface is implemented by servers that provide
      desktop-style user interfaces.

      It allows clients to associate a wl_shell_surface with
      a basic surface.

      Note! This protocol is deprecated and not intended for production use.
      For desktop-style user interfaces, use xdg_shell. Compositors and clients
      should not implement this interface.
"))

(DEFGENERIC GET-SHELL-SURFACE
    (RESOURCE ID SURFACE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0)
                WL_SHELL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_shell_surface")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "no")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_shell")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_shell")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'GET-SHELL-SURFACE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "create desktop-style surfaces

This interface is implemented by servers that provide
      desktop-style user interfaces.

      It allows clients to associate a wl_shell_surface with
      a basic surface.

      Note! This protocol is deprecated and not intended for production use.
      For desktop-style user interfaces, use xdg_shell. Compositors and clients
      should not implement this interface.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_shell global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_shell")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_shell")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_shell")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SHELL_SURFACE)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "desktop-style metadata interface

An interface that may be implemented by a wl_surface, for
      implementations that provide a desktop-style user interface.

      It provides requests to treat surfaces like toplevel, fullscreen
      or popup windows, move, resize or maximize them, associate
      metadata like title and class, etc.

      On the server side the object is automatically destroyed when
      the related wl_surface is destroyed. On the client side,
      wl_shell_surface_destroy() must be called before destroying
      the wl_surface object.
"))

(DEFGENERIC PONG
    (RESOURCE SERIAL))

(DEFGENERIC MOVE
    (RESOURCE SEAT SERIAL))

(DEFGENERIC RESIZE
    (RESOURCE SEAT SERIAL EDGES))

(DEFGENERIC SET-TOPLEVEL
    (RESOURCE))

(DEFGENERIC SET-TRANSIENT
    (RESOURCE PARENT X Y FLAGS))

(DEFGENERIC SET-FULLSCREEN
    (RESOURCE METHOD FRAMERATE OUTPUT))

(DEFGENERIC SET-POPUP
    (RESOURCE SEAT SERIAL PARENT X Y FLAGS))

(DEFGENERIC SET-MAXIMIZED
    (RESOURCE OUTPUT))

(DEFGENERIC SET-TITLE
    (RESOURCE TITLE))

(DEFGENERIC SET-CLASS
    (RESOURCE CLASS_))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 10)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "pong")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SEAT::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "move")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "ou")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SEAT::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "resize")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "ouu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_toplevel")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_transient")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "oiiu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) WL_OUTPUT::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_fullscreen")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uu?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 6)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SEAT::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 5) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_popup")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "ouoiiu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_OUTPUT::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_maximized")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_title")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_class")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "ping")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "configure")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "popup_done")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_shell_surface")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 10
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_shell_surface")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'PONG RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))))
        (1
         (FUNCALL 'MOVE RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))))
        (2
         (FUNCALL 'RESIZE RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))
        (3 (FUNCALL 'SET-TOPLEVEL RESOURCE))
        (4
         (FUNCALL 'SET-TRANSIENT RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))
        (5
         (FUNCALL 'SET-FULLSCREEN RESOURCE
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (6
         (FUNCALL 'SET-POPUP RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))
        (7
         (FUNCALL 'SET-MAXIMIZED RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (8
         (FUNCALL 'SET-TITLE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::S))))
        (9
         (FUNCALL 'SET-CLASS RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::S))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-PING ((DISPATCH DISPATCH) SERIAL)
  (DEBUG-LOG! "Event: ~a~%" "ping")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-CONFIGURE ((DISPATCH DISPATCH) EDGES WIDTH HEIGHT)
  (DEBUG-LOG! "Event: ~a~%" "configure")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" EDGES)
              ("uint" EDGES)
              ("new_id" EDGES)
              ("fixed" EDGES)
              ("fd" EDGES)
              ("string" EDGES)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" WIDTH)
              ("uint" WIDTH)
              ("new_id" WIDTH)
              ("fixed" WIDTH)
              ("fd" WIDTH)
              ("string" WIDTH)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" HEIGHT)
              ("uint" HEIGHT)
              ("new_id" HEIGHT)
              ("fixed" HEIGHT)
              ("fd" HEIGHT)
              ("string" HEIGHT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-POPUP-DONE ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "popup_done")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "desktop-style metadata interface

An interface that may be implemented by a wl_surface, for
      implementations that provide a desktop-style user interface.

      It provides requests to treat surfaces like toplevel, fullscreen
      or popup windows, move, resize or maximize them, associate
      metadata like title and class, etc.

      On the server side the object is automatically destroyed when
      the related wl_surface is destroyed. On the client side,
      wl_shell_surface_destroy() must be called before destroying
      the wl_surface object.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_shell_surface global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_shell_surface")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_shell_surface")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_shell_surface")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SURFACE)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 6)
          (:DOCUMENTATION "an onscreen surface

A surface is a rectangular area that may be displayed on zero
      or more outputs, and shown any number of times at the compositor's
      discretion. They can present wl_buffers, receive user input, and
      define a local coordinate system.

      The size of a surface (and relative positions on it) is described
      in surface-local coordinates, which may differ from the buffer
      coordinates of the pixel content, in case a buffer_transform
      or a buffer_scale is used.

      A surface without a \"role\" is fairly useless: a compositor does
      not know where, when or how to present it. The role is the
      purpose of a wl_surface. Examples of roles are a cursor for a
      pointer (as set by wl_pointer.set_cursor), a drag icon
      (wl_data_device.start_drag), a sub-surface
      (wl_subcompositor.get_subsurface), and a window as defined by a
      shell protocol (e.g. wl_shell.get_shell_surface).

      A surface can have only one role at a time. Initially a
      wl_surface does not have a role. Once a wl_surface is given a
      role, it is set permanently for the whole lifetime of the
      wl_surface object. Giving the current role again is allowed,
      unless explicitly forbidden by the relevant interface
      specification.

      Surface roles are given by requests in other interfaces such as
      wl_pointer.set_cursor. The request should explicitly mention
      that this request gives a role to a wl_surface. Often, this
      request also creates a new protocol object that represents the
      role and adds additional functionality to wl_surface. When a
      client wants to destroy a wl_surface, they must destroy this role
      object before the wl_surface, otherwise a defunct_role_object error is
      sent.

      Destroying the role object does not remove the role from the
      wl_surface, but it may stop the wl_surface from \"playing the role\".
      For instance, if a wl_subsurface object is destroyed, the wl_surface
      it was created for will be unmapped and forget its position and
      z-order. It is allowed to create a wl_subsurface for the same
      wl_surface again, but it is not allowed to use the wl_surface as
      a cursor (cursor is a different role than sub-surface, and role
      switching is not allowed).
"))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC ATTACH
    (RESOURCE BUFFER X Y))

(DEFGENERIC DAMAGE
    (RESOURCE X Y WIDTH HEIGHT))

(DEFGENERIC FRAME
    (RESOURCE CALLBACK))

(DEFGENERIC SET-OPAQUE-REGION
    (RESOURCE REGION))

(DEFGENERIC SET-INPUT-REGION
    (RESOURCE REGION))

(DEFGENERIC COMMIT
    (RESOURCE))

(DEFGENERIC SET-BUFFER-TRANSFORM
    (RESOURCE TRANSFORM))

(DEFGENERIC SET-BUFFER-SCALE
    (RESOURCE SCALE))

(DEFGENERIC DAMAGE-BUFFER
    (RESOURCE X Y WIDTH HEIGHT))

(DEFGENERIC OFFSET
    (RESOURCE X Y))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 11)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_BUFFER::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "attach")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?oii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "damage")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "iiii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_CALLBACK::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "frame")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_REGION::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_opaque_region")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_REGION::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_input_region")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "?o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "commit")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_buffer_transform")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "2u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_buffer_scale")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3i")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "damage_buffer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "4iiii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "offset")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5ii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 4)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_OUTPUT::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "enter")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_OUTPUT::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "leave")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "preferred_buffer_scale")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "6i")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "preferred_buffer_transform")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "6u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_surface")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 11
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 4
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_surface")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0 (FUNCALL 'DESTROY RESOURCE))
        (1
         (FUNCALL 'ATTACH RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (2
         (FUNCALL 'DAMAGE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (3
         (FUNCALL 'FRAME RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (4
         (FUNCALL 'SET-OPAQUE-REGION RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (5
         (FUNCALL 'SET-INPUT-REGION RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (6 (FUNCALL 'COMMIT RESOURCE))
        (7
         (FUNCALL 'SET-BUFFER-TRANSFORM RESOURCE
                  (ERROR
                   "WL C enum not yet implemented. You wanted to create a lisp list with keywords")))
        (8
         (FUNCALL 'SET-BUFFER-SCALE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (9
         (FUNCALL 'DAMAGE-BUFFER RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (10
         (FUNCALL 'OFFSET RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-ENTER ((DISPATCH DISPATCH) OUTPUT)
  (DEBUG-LOG! "Event: ~a~%" "enter")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" OUTPUT)
              ("uint" OUTPUT)
              ("new_id" OUTPUT)
              ("fixed" OUTPUT)
              ("fd" OUTPUT)
              ("string" OUTPUT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-LEAVE ((DISPATCH DISPATCH) OUTPUT)
  (DEBUG-LOG! "Event: ~a~%" "leave")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" OUTPUT)
              ("uint" OUTPUT)
              ("new_id" OUTPUT)
              ("fixed" OUTPUT)
              ("fd" OUTPUT)
              ("string" OUTPUT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-PREFERRED-BUFFER-SCALE ((DISPATCH DISPATCH) FACTOR)
  (DEBUG-LOG! "Event: ~a~%" "preferred_buffer_scale")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FACTOR)
              ("uint" FACTOR)
              ("new_id" FACTOR)
              ("fixed" FACTOR)
              ("fd" FACTOR)
              ("string" FACTOR)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-PREFERRED-BUFFER-TRANSFORM ((DISPATCH DISPATCH) TRANSFORM)
  (DEBUG-LOG! "Event: ~a~%" "preferred_buffer_transform")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TRANSFORM)
              ("uint" TRANSFORM)
              ("new_id" TRANSFORM)
              ("fixed" TRANSFORM)
              ("fd" TRANSFORM)
              ("string" TRANSFORM)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 6 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "an onscreen surface

A surface is a rectangular area that may be displayed on zero
      or more outputs, and shown any number of times at the compositor's
      discretion. They can present wl_buffers, receive user input, and
      define a local coordinate system.

      The size of a surface (and relative positions on it) is described
      in surface-local coordinates, which may differ from the buffer
      coordinates of the pixel content, in case a buffer_transform
      or a buffer_scale is used.

      A surface without a \"role\" is fairly useless: a compositor does
      not know where, when or how to present it. The role is the
      purpose of a wl_surface. Examples of roles are a cursor for a
      pointer (as set by wl_pointer.set_cursor), a drag icon
      (wl_data_device.start_drag), a sub-surface
      (wl_subcompositor.get_subsurface), and a window as defined by a
      shell protocol (e.g. wl_shell.get_shell_surface).

      A surface can have only one role at a time. Initially a
      wl_surface does not have a role. Once a wl_surface is given a
      role, it is set permanently for the whole lifetime of the
      wl_surface object. Giving the current role again is allowed,
      unless explicitly forbidden by the relevant interface
      specification.

      Surface roles are given by requests in other interfaces such as
      wl_pointer.set_cursor. The request should explicitly mention
      that this request gives a role to a wl_surface. Often, this
      request also creates a new protocol object that represents the
      role and adds additional functionality to wl_surface. When a
      client wants to destroy a wl_surface, they must destroy this role
      object before the wl_surface, otherwise a defunct_role_object error is
      sent.

      Destroying the role object does not remove the role from the
      wl_surface, but it may stop the wl_surface from \"playing the role\".
      For instance, if a wl_subsurface object is destroyed, the wl_surface
      it was created for will be unmapped and forget its position and
      z-order. It is allowed to create a wl_subsurface for the same
      wl_surface again, but it is not allowed to use the wl_surface as
      a cursor (cursor is a different role than sub-surface, and role
      switching is not allowed).
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_surface global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_surface")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_surface")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_surface")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SEAT)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 9)
          (:DOCUMENTATION "group of input devices

A seat is a group of keyboards, pointer and touch devices. This
      object is published as a global during start up, or when such a
      device is hot plugged.  A seat typically has a pointer and
      maintains a keyboard focus and a pointer focus.
"))

(DEFGENERIC GET-POINTER
    (RESOURCE ID))

(DEFGENERIC GET-KEYBOARD
    (RESOURCE ID))

(DEFGENERIC GET-TOUCH
    (RESOURCE ID))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 4)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_POINTER::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_pointer")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_KEYBOARD::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_keyboard")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_TOUCH::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_touch")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "n")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "capabilities")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "name")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "2s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_seat")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 9
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 4
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_seat")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'GET-POINTER RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (1
         (FUNCALL 'GET-KEYBOARD RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (2
         (FUNCALL 'GET-TOUCH RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))))
        (3 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-CAPABILITIES ((DISPATCH DISPATCH) CAPABILITIES)
  (DEBUG-LOG! "Event: ~a~%" "capabilities")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" CAPABILITIES)
              ("uint" CAPABILITIES)
              ("new_id" CAPABILITIES)
              ("fixed" CAPABILITIES)
              ("fd" CAPABILITIES)
              ("string" CAPABILITIES)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-NAME ((DISPATCH DISPATCH) NAME)
  (DEBUG-LOG! "Event: ~a~%" "name")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" NAME)
              ("uint" NAME)
              ("new_id" NAME)
              ("fixed" NAME)
              ("fd" NAME)
              ("string" NAME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 9 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "group of input devices

A seat is a group of keyboards, pointer and touch devices. This
      object is published as a global during start up, or when such a
      device is hot plugged.  A seat typically has a pointer and
      maintains a keyboard focus and a pointer focus.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_seat global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_seat")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_seat")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_seat")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_POINTER)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 9)
          (:DOCUMENTATION "pointer input device

The wl_pointer interface represents one or more input devices,
      such as mice, which control the pointer location and pointer_focus
      of a seat.

      The wl_pointer interface generates motion, enter and leave
      events for the surfaces that the pointer is located over,
      and button and axis events for button presses, button releases
      and scrolling.
"))

(DEFGENERIC SET-CURSOR
    (RESOURCE SERIAL SURFACE HOTSPOT_X HOTSPOT_Y))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_cursor")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "u?oii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 11)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "enter")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uoff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "leave")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uo")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "motion")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "button")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uuuu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uuf")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "frame")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis_source")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5u")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis_stop")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5uu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis_discrete")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "5ui")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis_value120")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "8ui")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "axis_relative_direction")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "9uu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_pointer")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 9
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 11
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_pointer")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0
         (FUNCALL 'SET-CURSOR RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::U))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (1 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-ENTER ((DISPATCH DISPATCH) SERIAL SURFACE SURFACE_X SURFACE_Y)
  (DEBUG-LOG! "Event: ~a~%" "enter")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 4)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE_X)
              ("uint" SURFACE_X)
              ("new_id" SURFACE_X)
              ("fixed" SURFACE_X)
              ("fd" SURFACE_X)
              ("string" SURFACE_X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE_Y)
              ("uint" SURFACE_Y)
              ("new_id" SURFACE_Y)
              ("fixed" SURFACE_Y)
              ("fd" SURFACE_Y)
              ("string" SURFACE_Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-LEAVE ((DISPATCH DISPATCH) SERIAL SURFACE)
  (DEBUG-LOG! "Event: ~a~%" "leave")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-MOTION ((DISPATCH DISPATCH) TIME SURFACE_X SURFACE_Y)
  (DEBUG-LOG! "Event: ~a~%" "motion")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE_X)
              ("uint" SURFACE_X)
              ("new_id" SURFACE_X)
              ("fixed" SURFACE_X)
              ("fd" SURFACE_X)
              ("string" SURFACE_X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE_Y)
              ("uint" SURFACE_Y)
              ("new_id" SURFACE_Y)
              ("fixed" SURFACE_Y)
              ("fd" SURFACE_Y)
              ("string" SURFACE_Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-BUTTON ((DISPATCH DISPATCH) SERIAL TIME BUTTON STATE)
  (DEBUG-LOG! "Event: ~a~%" "button")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 4)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" BUTTON)
              ("uint" BUTTON)
              ("new_id" BUTTON)
              ("fixed" BUTTON)
              ("fd" BUTTON)
              ("string" BUTTON)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" STATE)
              ("uint" STATE)
              ("new_id" STATE)
              ("fixed" STATE)
              ("fd" STATE)
              ("string" STATE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-AXIS ((DISPATCH DISPATCH) TIME AXIS VALUE)
  (DEBUG-LOG! "Event: ~a~%" "axis")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS)
              ("uint" AXIS)
              ("new_id" AXIS)
              ("fixed" AXIS)
              ("fd" AXIS)
              ("string" AXIS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" VALUE)
              ("uint" VALUE)
              ("new_id" VALUE)
              ("fixed" VALUE)
              ("fd" VALUE)
              ("string" VALUE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-FRAME ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "frame")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFMETHOD SEND-AXIS-SOURCE ((DISPATCH DISPATCH) AXIS_SOURCE)
  (DEBUG-LOG! "Event: ~a~%" "axis_source")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS_SOURCE)
              ("uint" AXIS_SOURCE)
              ("new_id" AXIS_SOURCE)
              ("fixed" AXIS_SOURCE)
              ("fd" AXIS_SOURCE)
              ("string" AXIS_SOURCE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 6 ARG-LIST)))

(DEFMETHOD SEND-AXIS-STOP ((DISPATCH DISPATCH) TIME AXIS)
  (DEBUG-LOG! "Event: ~a~%" "axis_stop")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS)
              ("uint" AXIS)
              ("new_id" AXIS)
              ("fixed" AXIS)
              ("fd" AXIS)
              ("string" AXIS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 7 ARG-LIST)))

(DEFMETHOD SEND-AXIS-DISCRETE ((DISPATCH DISPATCH) AXIS DISCRETE)
  (DEBUG-LOG! "Event: ~a~%" "axis_discrete")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS)
              ("uint" AXIS)
              ("new_id" AXIS)
              ("fixed" AXIS)
              ("fd" AXIS)
              ("string" AXIS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DISCRETE)
              ("uint" DISCRETE)
              ("new_id" DISCRETE)
              ("fixed" DISCRETE)
              ("fd" DISCRETE)
              ("string" DISCRETE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 8 ARG-LIST)))

(DEFMETHOD SEND-AXIS-VALUE120 ((DISPATCH DISPATCH) AXIS VALUE120)
  (DEBUG-LOG! "Event: ~a~%" "axis_value120")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS)
              ("uint" AXIS)
              ("new_id" AXIS)
              ("fixed" AXIS)
              ("fd" AXIS)
              ("string" AXIS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" VALUE120)
              ("uint" VALUE120)
              ("new_id" VALUE120)
              ("fixed" VALUE120)
              ("fd" VALUE120)
              ("string" VALUE120)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 9 ARG-LIST)))

(DEFMETHOD SEND-AXIS-RELATIVE-DIRECTION ((DISPATCH DISPATCH) AXIS DIRECTION)
  (DEBUG-LOG! "Event: ~a~%" "axis_relative_direction")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" AXIS)
              ("uint" AXIS)
              ("new_id" AXIS)
              ("fixed" AXIS)
              ("fd" AXIS)
              ("string" AXIS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DIRECTION)
              ("uint" DIRECTION)
              ("new_id" DIRECTION)
              ("fixed" DIRECTION)
              ("fd" DIRECTION)
              ("string" DIRECTION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 10 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 9 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "pointer input device

The wl_pointer interface represents one or more input devices,
      such as mice, which control the pointer location and pointer_focus
      of a seat.

      The wl_pointer interface generates motion, enter and leave
      events for the surfaces that the pointer is located over,
      and button and axis events for button presses, button releases
      and scrolling.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_pointer global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_pointer")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_pointer")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_pointer")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_KEYBOARD)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 9)
          (:DOCUMENTATION "keyboard input device

The wl_keyboard interface represents one or more keyboards
      associated with a seat.
"))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 6)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "keymap")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uhu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "enter")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uoa")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "leave")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uo")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "key")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uuuu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 5)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "modifiers")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uuuuu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "repeat_info")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "4ii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_keyboard")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 9
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE ARGS))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_keyboard")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE (0 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-KEYMAP ((DISPATCH DISPATCH) FORMAT FD SIZE)
  (DEBUG-LOG! "Event: ~a~%" "keymap")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FORMAT)
              ("uint" FORMAT)
              ("new_id" FORMAT)
              ("fixed" FORMAT)
              ("fd" FORMAT)
              ("string" FORMAT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::H)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FD)
              ("uint" FD)
              ("new_id" FD)
              ("fixed" FD)
              ("fd" FD)
              ("string" FD)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SIZE)
              ("uint" SIZE)
              ("new_id" SIZE)
              ("fixed" SIZE)
              ("fd" SIZE)
              ("string" SIZE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-ENTER ((DISPATCH DISPATCH) SERIAL SURFACE KEYS)
  (DEBUG-LOG! "Event: ~a~%" "enter")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::A)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" KEYS)
              ("uint" KEYS)
              ("new_id" KEYS)
              ("fixed" KEYS)
              ("fd" KEYS)
              ("string" KEYS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-LEAVE ((DISPATCH DISPATCH) SERIAL SURFACE)
  (DEBUG-LOG! "Event: ~a~%" "leave")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-KEY ((DISPATCH DISPATCH) SERIAL TIME KEY STATE)
  (DEBUG-LOG! "Event: ~a~%" "key")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 4)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" KEY)
              ("uint" KEY)
              ("new_id" KEY)
              ("fixed" KEY)
              ("fd" KEY)
              ("string" KEY)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" STATE)
              ("uint" STATE)
              ("new_id" STATE)
              ("fixed" STATE)
              ("fd" STATE)
              ("string" STATE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-MODIFIERS
           ((DISPATCH DISPATCH) SERIAL MODS_DEPRESSED MODS_LATCHED MODS_LOCKED
            GROUP)
  (DEBUG-LOG! "Event: ~a~%" "modifiers")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 5)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MODS_DEPRESSED)
              ("uint" MODS_DEPRESSED)
              ("new_id" MODS_DEPRESSED)
              ("fixed" MODS_DEPRESSED)
              ("fd" MODS_DEPRESSED)
              ("string" MODS_DEPRESSED)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MODS_LATCHED)
              ("uint" MODS_LATCHED)
              ("new_id" MODS_LATCHED)
              ("fixed" MODS_LATCHED)
              ("fd" MODS_LATCHED)
              ("string" MODS_LATCHED)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MODS_LOCKED)
              ("uint" MODS_LOCKED)
              ("new_id" MODS_LOCKED)
              ("fixed" MODS_LOCKED)
              ("fd" MODS_LOCKED)
              ("string" MODS_LOCKED)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" GROUP)
              ("uint" GROUP)
              ("new_id" GROUP)
              ("fixed" GROUP)
              ("fd" GROUP)
              ("string" GROUP)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-REPEAT-INFO ((DISPATCH DISPATCH) RATE DELAY)
  (DEBUG-LOG! "Event: ~a~%" "repeat_info")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" RATE)
              ("uint" RATE)
              ("new_id" RATE)
              ("fixed" RATE)
              ("fd" RATE)
              ("string" RATE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DELAY)
              ("uint" DELAY)
              ("new_id" DELAY)
              ("fixed" DELAY)
              ("fd" DELAY)
              ("string" DELAY)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 9 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "keyboard input device

The wl_keyboard interface represents one or more keyboards
      associated with a seat.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_keyboard global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_keyboard")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_keyboard")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_keyboard")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_TOUCH)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 9)
          (:DOCUMENTATION "touchscreen input device

The wl_touch interface represents a touchscreen
      associated with a seat.

      Touch interactions can consist of one or more contacts.
      For each contact, a series of events is generated, starting
      with a down event, followed by zero or more motion events,
      and ending with an up event. Events relating to the same
      contact point can be identified by the ID of the sequence.
"))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 7)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 6)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 5) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "down")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uuoiff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "up")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uui")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "motion")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uiff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "frame")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "cancel")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "shape")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "6iff")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "orientation")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "6if")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_touch")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 9
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 7
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE ARGS))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_touch")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE (0 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-DOWN ((DISPATCH DISPATCH) SERIAL TIME SURFACE ID X Y)
  (DEBUG-LOG! "Event: ~a~%" "down")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 6)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::O)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SURFACE)
              ("uint" SURFACE)
              ("new_id" SURFACE)
              ("fixed" SURFACE)
              ("fd" SURFACE)
              ("string" SURFACE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" X)
              ("uint" X)
              ("new_id" X)
              ("fixed" X)
              ("fd" X)
              ("string" X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 5)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" Y)
              ("uint" Y)
              ("new_id" Y)
              ("fixed" Y)
              ("fd" Y)
              ("string" Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-UP ((DISPATCH DISPATCH) SERIAL TIME ID)
  (DEBUG-LOG! "Event: ~a~%" "up")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SERIAL)
              ("uint" SERIAL)
              ("new_id" SERIAL)
              ("fixed" SERIAL)
              ("fd" SERIAL)
              ("string" SERIAL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-MOTION ((DISPATCH DISPATCH) TIME ID X Y)
  (DEBUG-LOG! "Event: ~a~%" "motion")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 4)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TIME)
              ("uint" TIME)
              ("new_id" TIME)
              ("fixed" TIME)
              ("fd" TIME)
              ("string" TIME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" X)
              ("uint" X)
              ("new_id" X)
              ("fixed" X)
              ("fd" X)
              ("string" X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" Y)
              ("uint" Y)
              ("new_id" Y)
              ("fixed" Y)
              ("fd" Y)
              ("string" Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-FRAME ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "frame")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-CANCEL ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "cancel")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-SHAPE ((DISPATCH DISPATCH) ID MAJOR MINOR)
  (DEBUG-LOG! "Event: ~a~%" "shape")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 3)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MAJOR)
              ("uint" MAJOR)
              ("new_id" MAJOR)
              ("fixed" MAJOR)
              ("fd" MAJOR)
              ("string" MAJOR)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MINOR)
              ("uint" MINOR)
              ("new_id" MINOR)
              ("fixed" MINOR)
              ("fd" MINOR)
              ("string" MINOR)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFMETHOD SEND-ORIENTATION ((DISPATCH DISPATCH) ID ORIENTATION)
  (DEBUG-LOG! "Event: ~a~%" "orientation")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 2)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ID)
              ("uint" ID)
              ("new_id" ID)
              ("fixed" ID)
              ("fd" ID)
              ("string" ID)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::F)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" ORIENTATION)
              ("uint" ORIENTATION)
              ("new_id" ORIENTATION)
              ("fixed" ORIENTATION)
              ("fd" ORIENTATION)
              ("string" ORIENTATION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 6 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 9 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "touchscreen input device

The wl_touch interface represents a touchscreen
      associated with a seat.

      Touch interactions can consist of one or more contacts.
      For each contact, a series of events is generated, starting
      with a down event, followed by zero or more motion events,
      and ending with an up event. Events relating to the same
      contact point can be identified by the ID of the sequence.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_touch global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_touch")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_touch")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_touch")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_OUTPUT)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 4)
          (:DOCUMENTATION "compositor output region

An output describes part of the compositor geometry.  The
      compositor works in the 'compositor coordinate system' and an
      output corresponds to a rectangular area in that space that is
      actually visible.  This typically corresponds to a monitor that
      displays part of the compositor space.  This object is published
      as global during start up, or when a monitor is hotplugged.
"))

(DEFGENERIC RELEASE
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 1)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "release")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "3")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 6)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 8)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 4) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 5) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 6) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 7) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "geometry")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "iiiiussu")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "mode")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "uiii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "done")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "2")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "scale")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "2i")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "name")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "4s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "description")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "4s")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_output")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 4
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE ARGS))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_output")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE (0 (FUNCALL 'RELEASE RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFMETHOD SEND-GEOMETRY
           ((DISPATCH DISPATCH) X Y PHYSICAL_WIDTH PHYSICAL_HEIGHT SUBPIXEL
            MAKE MODEL TRANSFORM)
  (DEBUG-LOG! "Event: ~a~%" "geometry")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 8)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" X)
              ("uint" X)
              ("new_id" X)
              ("fixed" X)
              ("fd" X)
              ("string" X)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" Y)
              ("uint" Y)
              ("new_id" Y)
              ("fixed" Y)
              ("fd" Y)
              ("string" Y)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" PHYSICAL_WIDTH)
              ("uint" PHYSICAL_WIDTH)
              ("new_id" PHYSICAL_WIDTH)
              ("fixed" PHYSICAL_WIDTH)
              ("fd" PHYSICAL_WIDTH)
              ("string" PHYSICAL_WIDTH)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" PHYSICAL_HEIGHT)
              ("uint" PHYSICAL_HEIGHT)
              ("new_id" PHYSICAL_HEIGHT)
              ("fixed" PHYSICAL_HEIGHT)
              ("fd" PHYSICAL_HEIGHT)
              ("string" PHYSICAL_HEIGHT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 4)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" SUBPIXEL)
              ("uint" SUBPIXEL)
              ("new_id" SUBPIXEL)
              ("fixed" SUBPIXEL)
              ("fd" SUBPIXEL)
              ("string" SUBPIXEL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 5)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MAKE)
              ("uint" MAKE)
              ("new_id" MAKE)
              ("fixed" MAKE)
              ("fd" MAKE)
              ("string" MAKE)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 6)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" MODEL)
              ("uint" MODEL)
              ("new_id" MODEL)
              ("fixed" MODEL)
              ("fd" MODEL)
              ("string" MODEL)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 7)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" TRANSFORM)
              ("uint" TRANSFORM)
              ("new_id" TRANSFORM)
              ("fixed" TRANSFORM)
              ("fd" TRANSFORM)
              ("string" TRANSFORM)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 0 ARG-LIST)))

(DEFMETHOD SEND-MODE ((DISPATCH DISPATCH) FLAGS WIDTH HEIGHT REFRESH)
  (DEBUG-LOG! "Event: ~a~%" "mode")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 4)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::U)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FLAGS)
              ("uint" FLAGS)
              ("new_id" FLAGS)
              ("fixed" FLAGS)
              ("fd" FLAGS)
              ("string" FLAGS)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" WIDTH)
              ("uint" WIDTH)
              ("new_id" WIDTH)
              ("fixed" WIDTH)
              ("fd" WIDTH)
              ("string" WIDTH)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" HEIGHT)
              ("uint" HEIGHT)
              ("new_id" HEIGHT)
              ("fixed" HEIGHT)
              ("fd" HEIGHT)
              ("string" HEIGHT)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" REFRESH)
              ("uint" REFRESH)
              ("new_id" REFRESH)
              ("fixed" REFRESH)
              ("fd" REFRESH)
              ("string" REFRESH)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 1 ARG-LIST)))

(DEFMETHOD SEND-DONE ((DISPATCH DISPATCH))
  (DEBUG-LOG! "Event: ~a~%" "done")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 0)))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 2 ARG-LIST)))

(DEFMETHOD SEND-SCALE ((DISPATCH DISPATCH) FACTOR)
  (DEBUG-LOG! "Event: ~a~%" "scale")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::I)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" FACTOR)
              ("uint" FACTOR)
              ("new_id" FACTOR)
              ("fixed" FACTOR)
              ("fd" FACTOR)
              ("string" FACTOR)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 3 ARG-LIST)))

(DEFMETHOD SEND-NAME ((DISPATCH DISPATCH) NAME)
  (DEBUG-LOG! "Event: ~a~%" "name")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" NAME)
              ("uint" NAME)
              ("new_id" NAME)
              ("fixed" NAME)
              ("fd" NAME)
              ("string" NAME)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 4 ARG-LIST)))

(DEFMETHOD SEND-DESCRIPTION ((DISPATCH DISPATCH) DESCRIPTION)
  (DEBUG-LOG! "Event: ~a~%" "description")
  (LET ((ARG-LIST (FOREIGN-ALLOC '(:POINTER (:UNION WL_ARGUMENT)) :COUNT 1)))
    (SETF (FOREIGN-SLOT-VALUE
           (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
           '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 'BM-CL-LIBWAYLAND::S)
            (ALEXANDRIA:ESWITCH ((ARG-TYPE ARG) :TEST 'STRING=)
              ("int" DESCRIPTION)
              ("uint" DESCRIPTION)
              ("new_id" DESCRIPTION)
              ("fixed" DESCRIPTION)
              ("fd" DESCRIPTION)
              ("string" DESCRIPTION)
              ("enum"
               `(ERROR
                 "WL C enum not yet implemented. You wanted to create a lisp list with keywords"))
              ("object" `(BM-CL-WAYLAND:PTR ,(SYMBOLIFY (NAME ARG))))
              ("array" `(ERROR "WL C ARRAY PARSING NOT IMPLEMENTED"))))
    (RESOURCE-POST-EVENT (PTR DISPATCH) 5 ARG-LIST)))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 4 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "compositor output region

An output describes part of the compositor geometry.  The
      compositor works in the 'compositor coordinate system' and an
      output corresponds to a rectangular area in that space that is
      actually visible.  This typically corresponds to a monitor that
      displays part of the compositor space.  This object is published
      as global during start up, or when a monitor is hotplugged.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_output global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_output")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_output")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_output")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_REGION)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "region interface

A region object describes an area.

      Region objects are used to describe the opaque and input
      regions of a surface.
"))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC ADD
    (RESOURCE X Y WIDTH HEIGHT))

(DEFGENERIC SUBTRACT
    (RESOURCE X Y WIDTH HEIGHT))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 3)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "add")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "iiii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 4)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 3) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "subtract")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "iiii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_region")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 3
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_region")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0 (FUNCALL 'DESTROY RESOURCE))
        (1
         (FUNCALL 'ADD RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (2
         (FUNCALL 'SUBTRACT RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 3)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "region interface

A region object describes an area.

      Region objects are used to describe the opaque and input
      regions of a surface.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_region global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_region")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_region")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_region")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SUBCOMPOSITOR)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "sub-surface compositing

The global interface exposing sub-surface compositing capabilities.
      A wl_surface, that has sub-surfaces associated, is called the
      parent surface. Sub-surfaces can be arbitrarily nested and create
      a tree of sub-surfaces.

      The root surface in a tree of sub-surfaces is the main
      surface. The main surface cannot be a sub-surface, because
      sub-surfaces must always have a parent.

      A main surface with its sub-surfaces forms a (compound) window.
      For window management purposes, this set of wl_surface objects is
      to be considered as a single window, and it should also behave as
      such.

      The aim of sub-surfaces is to offload some of the compositing work
      within a window from clients to the compositor. A prime example is
      a video player with decorations and video in separate wl_surface
      objects. This should allow the compositor to pass YUV video buffer
      processing to dedicated overlay hardware when possible.
"))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC GET-SUBSURFACE
    (RESOURCE ID SURFACE PARENT))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 2)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 3)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SUBSURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) WL_SURFACE::*INTERFACE*)
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 2) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "get_subsurface")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "noo")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_subcompositor")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 2
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_subcompositor")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0 (FUNCALL 'DESTROY RESOURCE))
        (1
         (FUNCALL 'GET-SUBSURFACE RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::N))
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 2)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "sub-surface compositing

The global interface exposing sub-surface compositing capabilities.
      A wl_surface, that has sub-surfaces associated, is called the
      parent surface. Sub-surfaces can be arbitrarily nested and create
      a tree of sub-surfaces.

      The root surface in a tree of sub-surfaces is the main
      surface. The main surface cannot be a sub-surface, because
      sub-surfaces must always have a parent.

      A main surface with its sub-surfaces forms a (compound) window.
      For window management purposes, this set of wl_surface objects is
      to be considered as a single window, and it should also behave as
      such.

      The aim of sub-surfaces is to offload some of the compositing work
      within a window from clients to the compositor. A prime example is
      a video player with decorations and video in separate wl_surface
      objects. This should allow the compositor to pass YUV video buffer
      processing to dedicated overlay hardware when possible.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_subcompositor global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_subcompositor")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_subcompositor")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_subcompositor")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

(IN-PACKAGE :WL_SUBSURFACE)

(DEFCLASS DISPATCH (BM-CL-WAYLAND:OBJECT) NIL (:DEFAULT-INITARGS :VERSION 1)
          (:DOCUMENTATION "sub-surface interface to a wl_surface

An additional interface to a wl_surface object, which has been
      made a sub-surface. A sub-surface has one parent surface. A
      sub-surface's size and position are not limited to that of the parent.
      Particularly, a sub-surface is not automatically clipped to its
      parent's area.

      A sub-surface becomes mapped, when a non-NULL wl_buffer is applied
      and the parent surface is mapped. The order of which one happens
      first is irrelevant. A sub-surface is hidden if the parent becomes
      hidden, or if a NULL wl_buffer is applied. These rules apply
      recursively through the tree of surfaces.

      The behaviour of a wl_surface.commit request on a sub-surface
      depends on the sub-surface's mode. The possible modes are
      synchronized and desynchronized, see methods
      wl_subsurface.set_sync and wl_subsurface.set_desync. Synchronized
      mode caches the wl_surface state to be applied when the parent's
      state gets applied, and desynchronized mode applies the pending
      wl_surface state directly. A sub-surface is initially in the
      synchronized mode.

      Sub-surfaces also have another kind of state, which is managed by
      wl_subsurface requests, as opposed to wl_surface requests. This
      state includes the sub-surface position relative to the parent
      surface (wl_subsurface.set_position), and the stacking order of
      the parent and its sub-surfaces (wl_subsurface.place_above and
      .place_below). This state is applied when the parent surface's
      wl_surface state is applied, regardless of the sub-surface's mode.
      As the exception, set_sync and set_desync are effective immediately.

      The main surface can be thought to be always in desynchronized mode,
      since it does not have a parent in the sub-surfaces sense.

      Even if a sub-surface is in desynchronized mode, it will behave as
      in synchronized mode, if its parent surface behaves as in
      synchronized mode. This rule is applied recursively throughout the
      tree of surfaces. This means, that one can set a sub-surface into
      synchronized mode, and then assume that all its child and grand-child
      sub-surfaces are synchronized, too, without explicitly setting them.

      Destroying a sub-surface takes effect immediately. If you need to
      synchronize the removal of a sub-surface to the parent surface update,
      unmap the sub-surface first by attaching a NULL wl_buffer, update parent,
      and then destroy the sub-surface.

      If the parent wl_surface object is destroyed, the sub-surface is
      unmapped.
"))

(DEFGENERIC DESTROY
    (RESOURCE))

(DEFGENERIC SET-POSITION
    (RESOURCE X Y))

(DEFGENERIC PLACE-ABOVE
    (RESOURCE SIBLING))

(DEFGENERIC PLACE-BELOW
    (RESOURCE SIBLING))

(DEFGENERIC SET-SYNC
    (RESOURCE))

(DEFGENERIC SET-DESYNC
    (RESOURCE))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *REQUESTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 6)))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "destroy")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 2)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) (NULL-POINTER))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 1) (NULL-POINTER))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_position")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "ii")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "place_above")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 1)))
        (SETF (MEM-AREF INTERFACE-ARRAY :POINTER 0) WL_SURFACE::*INTERFACE*)
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "place_below")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "o")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_sync")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      (LET ((INTERFACE-ARRAY
             (CFFI:FOREIGN-ALLOC '(:POINTER (:POINTER :VOID)) :COUNT 0)))
        (SETF (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::NAME)
                (FOREIGN-STRING-ALLOC "set_desync")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::SIGNATURE)
                (FOREIGN-STRING-ALLOC "")
              (FOREIGN-SLOT-VALUE MESSAGES '(:STRUCT WL_MESSAGE)
               'BM-CL-LIBWAYLAND::TYPES)
                INTERFACE-ARRAY))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *EVENTS*
    (LET ((MESSAGES (CFFI:FOREIGN-ALLOC '(:STRUCT WL_MESSAGE) :COUNT 0)))
      MESSAGES)))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (SETF (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'NAME)
          (FOREIGN-STRING-ALLOC "wl_subsurface")
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'VERSION) 1
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHOD_COUNT) 6
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'METHODS)
          *REQUESTS*
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENT_COUNT) 0
        (FOREIGN-SLOT-VALUE *INTERFACE* '(:STRUCT INTERFACE) 'EVENTS) *EVENTS*))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCHER-FFI
      :INT
      ((DATA :POINTER) (TARGET :POINTER) (OPCODE :UINT) (MESSAGE :POINTER)
       (ARGS :POINTER))
    (DECLARE (IGNORE DATA MESSAGE))
    (DEBUG-LOG! "Dispatcher invoked: ~a~%" "wl_subsurface")
    (LET ((RESOURCE (GETHASH (POINTER-ADDRESS TARGET) *RESOURCE-TRACKER*)))
      (ECASE OPCODE
        (0 (FUNCALL 'DESTROY RESOURCE))
        (1
         (FUNCALL 'SET-POSITION RESOURCE
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))
                  (VALUES
                   (FOREIGN-SLOT-VALUE
                    (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 1)
                    '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                    'BM-CL-LIBWAYLAND::I))))
        (2
         (FUNCALL 'PLACE-ABOVE RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (3
         (FUNCALL 'PLACE-BELOW RESOURCE
                  (GETHASH
                   (POINTER-ADDRESS
                    (FOREIGN-SLOT-VALUE
                     (MEM-APTR ARGS '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT) 0)
                     '(:UNION BM-CL-LIBWAYLAND:WL_ARGUMENT)
                     'BM-CL-LIBWAYLAND::O))
                   *RESOURCE-TRACKER*)))
        (4 (FUNCALL 'SET-SYNC RESOURCE))
        (5 (FUNCALL 'SET-DESYNC RESOURCE))))
    0))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCHER* (CALLBACK DISPATCHER-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((INSTANCE DISPATCH) &KEY)
  (LET* ((RESOURCE
          (CREATE-RESOURCE (PTR (CLIENT INSTANCE)) *INTERFACE*
           (VERSION INSTANCE) (ID INSTANCE))))
    (SETF (GETHASH (POINTER-ADDRESS RESOURCE) *RESOURCE-TRACKER*) INSTANCE)
    (RESOURCE-SET-DISPATCHER RESOURCE *DISPATCHER* (NULL-POINTER)
     (NULL-POINTER) (NULL-POINTER))))

(DEFCLASS GLOBAL (BM-CL-WAYLAND::GLOBAL) NIL
          (:DEFAULT-INITARGS :VERSION 1 :DISPATCH-IMPL 'DISPATCH)
          (:DOCUMENTATION "sub-surface interface to a wl_surface

An additional interface to a wl_surface object, which has been
      made a sub-surface. A sub-surface has one parent surface. A
      sub-surface's size and position are not limited to that of the parent.
      Particularly, a sub-surface is not automatically clipped to its
      parent's area.

      A sub-surface becomes mapped, when a non-NULL wl_buffer is applied
      and the parent surface is mapped. The order of which one happens
      first is irrelevant. A sub-surface is hidden if the parent becomes
      hidden, or if a NULL wl_buffer is applied. These rules apply
      recursively through the tree of surfaces.

      The behaviour of a wl_surface.commit request on a sub-surface
      depends on the sub-surface's mode. The possible modes are
      synchronized and desynchronized, see methods
      wl_subsurface.set_sync and wl_subsurface.set_desync. Synchronized
      mode caches the wl_surface state to be applied when the parent's
      state gets applied, and desynchronized mode applies the pending
      wl_surface state directly. A sub-surface is initially in the
      synchronized mode.

      Sub-surfaces also have another kind of state, which is managed by
      wl_subsurface requests, as opposed to wl_surface requests. This
      state includes the sub-surface position relative to the parent
      surface (wl_subsurface.set_position), and the stacking order of
      the parent and its sub-surfaces (wl_subsurface.place_above and
      .place_below). This state is applied when the parent surface's
      wl_surface state is applied, regardless of the sub-surface's mode.
      As the exception, set_sync and set_desync are effective immediately.

      The main surface can be thought to be always in desynchronized mode,
      since it does not have a parent in the sub-surfaces sense.

      Even if a sub-surface is in desynchronized mode, it will behave as
      in synchronized mode, if its parent surface behaves as in
      synchronized mode. This rule is applied recursively throughout the
      tree of surfaces. This means, that one can set a sub-surface into
      synchronized mode, and then assume that all its child and grand-child
      sub-surfaces are synchronized, too, without explicitly setting them.

      Destroying a sub-surface takes effect immediately. If you need to
      synchronize the removal of a sub-surface to the parent surface update,
      unmap the sub-surface first by attaching a NULL wl_buffer, update parent,
      and then destroy the sub-surface.

      If the parent wl_surface object is destroyed, the sub-surface is
      unmapped.
"))

(DEFMETHOD DISPATCH-BIND ((GLOBAL GLOBAL) CLIENT DATA VERSION ID)
  "Default bind implementation for the wl_subsurface global object.
This can be overriden by inheritance in case if custom behaviour is required."
  (DEBUG-LOG! "Binding ~a~%" "wl_subsurface")
  (LET ((BOUND
         (MAKE-INSTANCE (DISPATCH-IMPL GLOBAL) :DISPLAY (DISPLAY CLIENT)
                        :CLIENT CLIENT :ID ID)))
    (SETF (IFACE CLIENT ID) BOUND)))

(EVAL-WHEN (:COMPILE-TOPLEVEL :LOAD-TOPLEVEL :EXECUTE)
  (CL-ASYNC-UTIL:DEFINE-C-CALLBACK DISPATCH-BIND-FFI
      :VOID
      ((CLIENT :POINTER) (DATA :POINTER) (VERSION :UINT) (ID :UINT))
    (DEBUG-LOG! "C-Binding ~a~%" "wl_subsurface")
    (LET* ((CLIENT (GET-CLIENT CLIENT)) (GLOBAL (GET-DATA DATA)))
      (FUNCALL 'DISPATCH-BIND GLOBAL CLIENT (NULL-POINTER) VERSION ID))))

(EVAL-WHEN (:LOAD-TOPLEVEL :EXECUTE)
  (DEFVAR *DISPATCH-BIND* (CALLBACK DISPATCH-BIND-FFI)))

(DEFMETHOD INITIALIZE-INSTANCE :AFTER ((GLOBAL GLOBAL) &KEY)
  (DEBUG-LOG! "Initializing global object: ~a~%" "wl_subsurface")
  (LET* ((NEXT-DATA-ID (RESERVE-DATA))
         (GLOBAL-PTR
          (GLOBAL-CREATE (DISPLAY GLOBAL) *INTERFACE* (VERSION GLOBAL)
           (DATA-PTR NEXT-DATA-ID) *DISPATCH-BIND*)))
    (SETF (BM-CL-WAYLAND:PTR GLOBAL) GLOBAL-PTR)
    (SET-DATA NEXT-DATA-ID
     (SETF (GETHASH (POINTER-ADDRESS GLOBAL-PTR) *GLOBAL-TRACKER*) GLOBAL))))

